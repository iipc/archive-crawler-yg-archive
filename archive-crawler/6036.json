{"ygPerms":{"resourceCapabilityList":[{"resourceType":"GROUP","capabilities":[{"name":"READ"},{"name":"JOIN"}]},{"resourceType":"PHOTO","capabilities":[]},{"resourceType":"FILE","capabilities":[]},{"resourceType":"MEMBER","capabilities":[]},{"resourceType":"LINK","capabilities":[]},{"resourceType":"CALENDAR","capabilities":[]},{"resourceType":"DATABASE","capabilities":[]},{"resourceType":"POLL","capabilities":[]},{"resourceType":"MESSAGE","capabilities":[{"name":"READ"}]},{"resourceType":"PENDING_MESSAGE","capabilities":[]},{"resourceType":"ATTACHMENTS","capabilities":[{"name":"READ"}]},{"resourceType":"PHOTOMATIC_ALBUMS","capabilities":[]},{"resourceType":"MEMBERSHIP_TYPE","capabilities":[]},{"resourceType":"POST","capabilities":[{"name":"READ"}]},{"resourceType":"PIN","capabilities":[]}],"groupUrl":"groups.yahoo.com","intlCode":"us"},"comscore":"pageview_candidate","ygData":{"userId":137477665,"authorName":"igor@archive.org","from":"igor@...","profile":"iranitovic","replyTo":"LIST","senderId":"0RpQ8um9wvViMMwISQG0zBnA8HE7_GybUuQiHpw20qdfVHwsU0CVnyfZ18Rki6o-liAerozjVA","spamInfo":{"isSpam":false,"reason":"3"},"subject":"Re: [archive-crawler] ServerCache lookup stuck","postDate":"1253062975","msgId":6036,"canDelete":false,"contentTrasformed":false,"systemMessage":false,"headers":{"messageIdInHeader":"PDUzOTUyLjM4Ljk5LjQyLjI0NC4xMjUzMDYyOTc1LnNxdWlycmVsQG1haWwuYXJjaGl2ZS5vcmc+","inReplyToHeader":"PDRBQUY0MkJCLjcwMUBhcmNoaXZlLm9yZz4=","referencesHeader":"PGg4aXBmcytsaHBwQGVHcm91cHMuY29tPiAgICA8NjE3MDYuOTguMjM0Ljg2LjE2Ny4xMjUyODY4NTU2LnNxdWlycmVsQG1haWwuYXJjaGl2ZS5vcmc+ICAgIDw0QUFFMDg5Qi41MDMwODA0QGFyY2hpdmUub3JnPiAgICA8NjQxMzMuMzguOTkuNDIuMjQ0LjEyNTI5NTE4NjAuc3F1aXJyZWxAbWFpbC5hcmNoaXZlLm9yZz4gICAgPDRBQUY0MkJCLjcwMUBhcmNoaXZlLm9yZz4="},"prevInTopic":6033,"nextInTopic":6042,"prevInTime":6035,"nextInTime":6037,"topicId":6026,"numMessagesInTopic":15,"msgSnippet":"... I attached a file with more info. ... There are 4 additional threads that are stuck in the same loop: 3 JMX import URIs and one","rawEmail":"Return-Path: &lt;igor@...&gt;\r\nX-Sender: igor@...\r\nX-Apparently-To: archive-crawler@yahoogroups.com\r\nX-Received: (qmail 52642 invoked from network); 16 Sep 2009 01:03:30 -0000\r\nX-Received: from unknown (69.147.108.202)\n  by m3.grp.sp2.yahoo.com with QMQP; 16 Sep 2009 01:03:30 -0000\r\nX-Received: from unknown (HELO mail.archive.org) (207.241.231.239)\n  by mta3.grp.re1.yahoo.com with SMTP; 16 Sep 2009 01:03:28 -0000\r\nX-Received: from localhost (localhost [127.0.0.1])\n\tby mail.archive.org (Postfix) with ESMTP id 616E12A645B\n\tfor &lt;archive-crawler@yahoogroups.com&gt;; Tue, 15 Sep 2009 18:03:28 -0700 (PDT)\r\nX-Received: from mail.archive.org ([127.0.0.1])\n\tby localhost (mail.archive.org [127.0.0.1]) (amavisd-new, port 10024)\n\twith LMTP id 3aWaCBHstiaA for &lt;archive-crawler@yahoogroups.com&gt;;\n\tTue, 15 Sep 2009 18:03:28 -0700 (PDT)\r\nX-Received: from mail.archive.org (localhost [127.0.0.1])\n\tby mail.archive.org (Postfix) with ESMTP id C5E9B2A64C6\n\tfor &lt;archive-crawler@yahoogroups.com&gt;; Tue, 15 Sep 2009 18:02:55 -0700 (PDT)\r\nX-Received: from 38.99.42.244\n        (SquirrelMail authenticated user igor@...)\n        by mail.archive.org with HTTP;\n        Tue, 15 Sep 2009 18:02:55 -0700 (PDT)\r\nMessage-ID: &lt;53952.38.99.42.244.1253062975.squirrel@...&gt;\r\nIn-Reply-To: &lt;4AAF42BB.701@...&gt;\r\nReferences: &lt;h8ipfs+lhpp@...&gt;\n    &lt;61706.98.234.86.167.1252868556.squirrel@...&gt;\n    &lt;4AAE089B.5030804@...&gt;\n    &lt;64133.38.99.42.244.1252951860.squirrel@...&gt;\n    &lt;4AAF42BB.701@...&gt;\r\nDate: Tue, 15 Sep 2009 18:02:55 -0700 (PDT)\r\nTo: archive-crawler@yahoogroups.com\r\nUser-Agent: SquirrelMail/1.4.10a\r\nMIME-Version: 1.0\r\nContent-Type: multipart/mixed;boundary=&quot;----=_20090915180255_29467&quot;\r\nX-Priority: 3 (Normal)\r\nImportance: Normal\r\nX-eGroups-Msg-Info: 2:3:4:0:0\r\nFrom: igor@...\r\nSubject: Re: [archive-crawler] ServerCache lookup stuck\r\nX-Yahoo-Group-Post: member; u=137477665; y=jdylWS9K2muBN1ceOxu-mWtuzyGPky4bR_PM1d2GstXSwJboiw\r\nX-Yahoo-Profile: iranitovic\r\n\r\n\r\n------=_20090915180255_29467\r\nContent-Type: text/plain; charset=&quot;iso-8859-1&quot;\r\nContent-Transfer-Encoding: 8bit\r\n\r\n&gt; Still investigating, but thoughts so far:\n&gt;\n&gt; A notable thing about the &quot;ToeThread #19&quot; dumps is that they are usually\n&gt; BLOCKED waiting for the monitor on a specific CachedBdbMap$SoftEntry\n&gt; instance (&lt;0x97f40ad8&gt;, corresponding to the one server of interest to\n&gt; the URI-in-progress). That means some other thread holds it. But\n&gt; occasionally, tt#19 holds that lock.\n\nI attached a file with more info.\n\n&gt; This alternation suggests the other thread or threads are contributors\n&gt; to the problem state. You mentioned these might be in the middle of a\n&gt; JMX URI import; can you share some of those stacks, too? (Indeed, any\n&gt; stack with a reference to &lt;0x97f40ad8&gt; from the same all-threads-dump.)\n\nThere are 4 additional threads that are stuck in the same loop: 3 JMX\nimport URIs and one *gui-kill-and-replace-thread* threads.\n\nInitially there were only two stuck threads, tt#19 and one JMX import URI\nthread. The URI import process is sequential, one url at time, across all\nTLDs. Heritrix instance does not discover URLs itself at all.\n\nI end up with two more stuck JMX import URI threads because I restarted\nthe URI import process twice with incorrect filter that drops urls from\nthe *problematic* site/source-server.\n\nI also tried to kill tt#9 via GUI but that did not work. Thus, another\nstuck thread.\n\n&gt; Also, is the reported CPU usage negligible, pegged-near-100%, or\n&gt; somewhere in between?\n\nThe java process uses about 50% of all cores and that is pretty much\nconstant even when the crawler instance is paused. There is a constant JMX\nimport URI activity, but that is single threaded and I cannot image it\nbeing CPU intensive.\n\n&gt; Is there a chance the JMX threads are adding many URIs from this same\n&gt; source server, and are making very very slow contended progress? (A\n&gt; frontier report might show the count of URIs on the corresponding queue\n&gt; growing, and maybe even &#39;lsof -o&#39; would show any read-position progress\n&gt; in the source files for the JMX operation, confirming some progress.) It\n&gt; would be good to know if this is a true endless-hysteresis/loop or just\n&gt; pathological slowness under a certain kind of contention.\n\nNo, that is not the case.\n\n&gt; What does the heap usage look like? (The behavior of CachedBdbMap is\n&gt; intentionally GC-sensitive; operation under low-memory conditions, where\n&gt; something is GC&#39;d as soon as it&#39;s created, could be part of the problem\n&gt; cycle. But that&#39;s less likely a factor to consider if there&#39;s plenty of\n&gt; heap free space.)\n\nIt is using only a half of the max heap value.\n\n&gt; Are you hoping to kick this crawl back into working state (which might\n&gt; be possible with enough trickery once we understand the problem), or\n&gt; just keeping it around for debugging?\n\nI will like to have it in a working state sooner or later either by\nrestart or some other trickery. But for now it is still up and running.\n\nThanks Gordon.\ni.\n\n\n&gt; - Gordon @ IA\n&gt;\n&gt; igor@... wrote:\n&gt;&gt; Hi Gordon,\n&gt;&gt;\n&gt;&gt; Thanks for looking into it. See comments below.\n&gt;&gt;\n&gt;&gt;&gt; The CachedBdbMap somewhat recently (since last official release)\n&gt;&gt;&gt; underwent some major refactoring to improve concurrency. The test\n&gt;&gt;&gt; coverage is reasonable and the code has been through some volume tests\n&gt;&gt;&gt; without showing problems, but this might be a new bug triggered by that\n&gt;&gt;&gt; code.\n&gt;&gt;&gt; If you pause the crawl, I presume only that one thread remains active.\n&gt;&gt;&gt; Is that right?\n&gt;&gt;\n&gt;&gt; Only one toe thread, that is right.\n&gt;&gt;\n&gt;&gt;&gt; Is the CPU busy with only that thread active? I&#39;m still considering the\n&gt;&gt;&gt; other stacks you forwarded in a subsequent message; can you collect\n&gt;&gt;&gt; even\n&gt;&gt;&gt; more samples to get a sense of which branches are always being taken in\n&gt;&gt;&gt; the relevant methods?\n&gt;&gt;\n&gt;&gt; There is more than one thread active given that there is JMX activities\n&gt;&gt; even when the crawl is paused.\n&gt;&gt;\n&gt;&gt; There are at least two more JMX threads (trying to import an URI) that\n&gt;&gt; are\n&gt;&gt; stuck in the same loop as the toe thread.\n&gt;&gt;\n&gt;&gt; I attached a file with 100 quick thread dumps related to toe thread #19.\n&gt;&gt;\n&gt;&gt;&gt; The CachedBdbMap depends on some some garbage-collection-related\n&gt;&gt;&gt; trickery that might not be reliable in all JVMs. Can you say what\n&gt;&gt;&gt; JVM/host OS you&#39;re using?\n&gt;&gt;\n&gt;&gt; Sun&#39;s 1.6 (1.6.0_10-b33) and CentOS (CentOS release 5.3 (Final)).\n&gt;&gt;\n&gt;&gt; i.\n&gt;&gt;\n&gt;&gt;&gt; igor@... wrote:\n&gt;&gt;&gt;&gt; I got a stuck thread that is disrupting the crawl.\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; Heritrix verion:\n&gt;&gt;&gt;&gt; 1.15.4 (checked out on 9/9/2009)\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; Java env:\n&gt;&gt;&gt;&gt; Linux 2.6.18-128.1.10.el5PAE #1 SMP Thu May 7 11:14:31 EDT 2009 i686\n&gt;&gt;&gt;&gt; i686\n&gt;&gt;&gt;&gt; i386 GNU/Linux\n&gt;&gt;&gt;&gt; java version &quot;1.6.0_10&quot;\n&gt;&gt;&gt;&gt; Java(TM) SE Runtime Environment (build 1.6.0_10-b33)\n&gt;&gt;&gt;&gt; Java HotSpot(TM) Server VM (build 11.0-b15, mixed mode)\n&gt;&gt;&gt;&gt; JAVA_OPTS=-Xmx512m\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; Sleepycat:\n&gt;&gt;&gt;&gt; je-3.3.82.jar\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; Here is the thread dump:\n&gt;&gt;&gt;&gt; ToeThread #19: http://newyork.craigslist.org/mnh/tix/1371733715.html\n&gt;&gt;&gt;&gt;  CrawlURI http://newyork.craigslist.org/mnh/tix/1371733715.html      1\n&gt;&gt;&gt;&gt; attempts\n&gt;&gt;&gt;&gt;     in processor: Preprocessor\n&gt;&gt;&gt;&gt;     ACTIVE for 16h25m22s108ms\n&gt;&gt;&gt;&gt;     step: ABOUT_TO_BEGIN_PROCESSOR for 16h25m22s108ms\n&gt;&gt;&gt;&gt;     org.archive.util.CachedBdbMap$SoftEntry.getPhantom(CachedBdbMap.java:1625)\n&gt;&gt;&gt;&gt;     org.archive.util.CachedBdbMap$SoftEntry.isCleared(CachedBdbMap.java:1632)\n&gt;&gt;&gt;&gt;     org.archive.util.CachedBdbMap$SoftEntry.startExpunge(CachedBdbMap.java:1693)\n&gt;&gt;&gt;&gt;     org.archive.util.CachedBdbMap.isExpunged(CachedBdbMap.java:490)\n&gt;&gt;&gt;&gt;     org.archive.util.CachedBdbMap._getMem(CachedBdbMap.java:698)\n&gt;&gt;&gt;&gt;     org.archive.util.CachedBdbMap.get(CachedBdbMap.java:627)\n&gt;&gt;&gt;&gt;     org.archive.crawler.datamodel.ServerCache.getServerFor(ServerCache.java:99)\n&gt;&gt;&gt;&gt;     org.archive.crawler.datamodel.ServerCache.getServerFor(ServerCache.java:124)\n&gt;&gt;&gt;&gt;     org.archive.crawler.prefetch.PreconditionEnforcer.considerDnsPreconditions(PreconditionEnforcer.java:227)\n&gt;&gt;&gt;&gt;     org.archive.crawler.prefetch.PreconditionEnforcer.innerProcess(PreconditionEnforcer.java:111)\n&gt;&gt;&gt;&gt;     org.archive.crawler.framework.Processor.process(Processor.java:112)\n&gt;&gt;&gt;&gt;     org.archive.crawler.framework.ToeThread.processCrawlUri(ToeThread.java:302)\n&gt;&gt;&gt;&gt;     org.archive.crawler.framework.ToeThread.run(ToeThread.java:151)\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; i.\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; ------------------------------------\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; Yahoo! Groups Links\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt; ------------------------------------\n&gt;&gt;&gt;\n&gt;&gt;&gt; Yahoo! Groups Links\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;\n&gt;&gt;\n&gt;&gt;\n&gt;&gt; ------------------------------------\n&gt;&gt;\n&gt;&gt; Yahoo! Groups Links\n&gt;&gt;\n&gt;&gt;\n&gt;&gt;\n&gt;\n&gt;\n&gt; ------------------------------------\n&gt;\n&gt; Yahoo! Groups Links\n&gt;\n&gt;\n&gt;\n&gt;\r\n------=_20090915180255_29467\r\nContent-Type: text/plain; name=&quot;lock-97f40ad8.txt&quot;\r\nContent-Disposition: attachment; filename=&quot;lock-97f40ad8.txt&quot;\r\n\r\n[ Attachment content not displayed ]\r\n------=_20090915180255_29467--\r\n\n"}}