{"ygPerms":{"resourceCapabilityList":[{"resourceType":"GROUP","capabilities":[{"name":"READ"},{"name":"JOIN"}]},{"resourceType":"PHOTO","capabilities":[]},{"resourceType":"FILE","capabilities":[]},{"resourceType":"MEMBER","capabilities":[]},{"resourceType":"LINK","capabilities":[]},{"resourceType":"CALENDAR","capabilities":[]},{"resourceType":"DATABASE","capabilities":[]},{"resourceType":"POLL","capabilities":[]},{"resourceType":"MESSAGE","capabilities":[{"name":"READ"}]},{"resourceType":"PENDING_MESSAGE","capabilities":[]},{"resourceType":"ATTACHMENTS","capabilities":[{"name":"READ"}]},{"resourceType":"PHOTOMATIC_ALBUMS","capabilities":[]},{"resourceType":"MEMBERSHIP_TYPE","capabilities":[]},{"resourceType":"POST","capabilities":[{"name":"READ"}]},{"resourceType":"PIN","capabilities":[]}],"groupUrl":"groups.yahoo.com","intlCode":"us"},"comscore":"pageview_candidate","ygData":{"userId":325624130,"authorName":"Noah Levitt","from":"Noah Levitt &lt;nlevitt@...&gt;","profile":"nlevitt","replyTo":"LIST","senderId":"2C2o_japPerD7Z9iXjZuGoKoZJqhPEvsbJl7zdqHss8xN-itdK7zoNTn9G1QbVc4Ft1NwzmP3KBfU6eztenPoamrPhgYzial","spamInfo":{"isSpam":false,"reason":"0"},"subject":"Re: [archive-crawler] RE: HER-2070 or: Any news on the Cookie Monster bug","postDate":"1412103718","msgId":8624,"canDelete":false,"contentTrasformed":false,"systemMessage":false,"headers":{"messageIdInHeader":"PENBQS16NzBLUTdhNlVEaEFtZnhvQTMwb29WS3VuVlVrPVlKRURjX2ZOQk9oM01QamlZd0BtYWlsLmdtYWlsLmNvbT4=","inReplyToHeader":"PENBQS16NzBKY1c9Nm0tV3c2YTh3Sz1ENm5IUXNHNFhBckRvUG9lWUMyTFBxYytDOU44QUBtYWlsLmdtYWlsLmNvbT4=","referencesHeader":"PEU0ODZEOTNFMzcyRDhDNDI4MkU4REYwNzgzOTJGMTJERTBFQzNEQGJsaWtpLmJva2hsYWRhLmxvY2FsPgk8Q0FBLXo3MEpjVz02bS1XdzZhOHdLPUQ2bkhRc0c0WEFyRG9Qb2VZQzJMUHFjK0M5TjhBQG1haWwuZ21haWwuY29tPg=="},"prevInTopic":8623,"nextInTopic":8625,"prevInTime":8623,"nextInTime":8625,"topicId":8620,"numMessagesInTopic":9,"msgSnippet":"I m satisfied with https://github.com/internetarchive/heritrix3/pull/96 at this point. I wrote some unit and integration tests but certainly there could be ","rawEmail":"Return-Path: &lt;nlevitt@...&gt;\r\nX-Sender: nlevitt@...\r\nX-Apparently-To: archive-crawler@yahoogroups.com\r\nX-Received: (qmail 53741 invoked by uid 102); 30 Sep 2014 19:02:02 -0000\r\nX-Received: from unknown (HELO mtaq2.grp.bf1.yahoo.com) (10.193.84.33)\n  by m16.grp.bf1.yahoo.com with SMTP; 30 Sep 2014 19:02:02 -0000\r\nX-Received: (qmail 5995 invoked from network); 30 Sep 2014 19:02:02 -0000\r\nX-Received: from unknown (HELO mail.archive.org) (98.138.100.120)\n  by mtaq2.grp.bf1.yahoo.com with SMTP; 30 Sep 2014 19:02:02 -0000\r\nX-Received: from localhost (localhost [127.0.0.1])\n\tby mail.archive.org (Postfix) with ESMTP id 251D9A6219D\n\tfor &lt;archive-crawler@yahoogroups.com&gt;; Tue, 30 Sep 2014 12:02:01 -0700 (PDT)\r\nX-Received: from mail.archive.org ([127.0.0.1])\n\tby localhost (mail.archive.org [127.0.0.1]) (amavisd-new, port 10024)\n\twith LMTP id 1KCXuAvT3QOP for &lt;archive-crawler@yahoogroups.com&gt;;\n\tTue, 30 Sep 2014 12:01:59 -0700 (PDT)\r\nX-Received: from mail-qg0-f46.google.com (mail-qg0-f46.google.com [209.85.192.46])\n\tby mail.archive.org (Postfix) with ESMTPSA id 2583DA620DE\n\tfor &lt;archive-crawler@yahoogroups.com&gt;; Tue, 30 Sep 2014 12:01:59 -0700 (PDT)\r\nX-Received: by mail-qg0-f46.google.com with SMTP id a108so2413683qge.33\n        for &lt;archive-crawler@yahoogroups.com&gt;; Tue, 30 Sep 2014 12:01:58 -0700 (PDT)\r\nMIME-Version: 1.0\r\nX-Received: by 10.140.84.231 with SMTP id l94mr27202561qgd.84.1412103718242;\n Tue, 30 Sep 2014 12:01:58 -0700 (PDT)\r\nX-Received: by 10.97.2.169 with HTTP; Tue, 30 Sep 2014 12:01:58 -0700 (PDT)\r\nIn-Reply-To: &lt;CAA-z70JcW=6m-Ww6a8wK=D6nHQsG4XArDoPoeYC2LPqc+C9N8A@...&gt;\r\nReferences: &lt;E486D93E372D8C4282E8DF078392F12DE0EC3D@...&gt;\n\t&lt;CAA-z70JcW=6m-Ww6a8wK=D6nHQsG4XArDoPoeYC2LPqc+C9N8A@...&gt;\r\nDate: Tue, 30 Sep 2014 12:01:58 -0700\r\nMessage-ID: &lt;CAA-z70KQ7a6UDhAmfxoA30ooVKunVUk=YJEDc_fNBOh3MPjiYw@...&gt;\r\nTo: &quot;archive-crawler@yahoogroups.com&quot; &lt;archive-crawler@yahoogroups.com&gt;\r\nContent-Type: text/plain; charset=UTF-8\r\nContent-Transfer-Encoding: quoted-printable\r\nSubject: Re: [archive-crawler] RE: HER-2070 or: Any news on the Cookie Monster bug\r\nX-Yahoo-Group-Post: member; u=325624130; y=24g9yktREH1VEJDbp352MXceQae2_xGoavb8e-Ama0JiWQ\r\nX-Yahoo-Profile: nlevitt\r\nFrom: Noah Levitt &lt;nlevitt@...&gt;\r\n\r\nI&#39;m satisfied with\nhttps://github.com/internetarchive/heritrix3/pull/96 at =\r\nthis point. I\nwrote some unit and integration tests but certainly there cou=\r\nld be\nmore. (The structure is already there in\nCookieFetchHTTPIntegrationTe=\r\nst so adding more scenarios is not\ndifficult.) I&#39;ve also changed the implem=\r\nentation based on a suggestion\nfrom Gordon, which in hindsight is obvious -=\r\n- organize the cookies by\nhost, and include the cookies from each parent do=\r\nmain up to the top\nprivate domain, in the cookie store facade passed to the=\r\n http client\nlibrary call. Gordon also suggested a change to the bdb storag=\r\ne\nstructure which improved performance by an order of magnitude. Thanks\nfor=\r\n the code review Gordon.\n\nWould appreciate further review, testing, and of =\r\ncourse merging,\nespecially from folks most concerned about the bug.\n\nThanks=\r\n\nNoah\n\n\nOn Sat, Sep 27, 2014 at 2:17 PM, Noah Levitt &lt;nlevitt@...&gt; =\r\nwrote:\n&gt; Hello,\n&gt;\n&gt; I think I have a workable solution to this problem. The=\r\n idea is to\n&gt; organize the cookies in the cookie store by topmost assigned =\r\ndomain,\n&gt; aka top private domain. On each http request, supply to the fetch=\r\ner an\n&gt; implementation of org.apache.http.client.CookieStore that is a faca=\r\nde\n&gt; over the real cookie store, but only knows about the cookies belonging=\r\n\n&gt; to the topmost assigned domain of the url being fetched. That way the\n&gt; =\r\nlist of cookies that gets copied and iterated over stays relatively\n&gt; small=\r\n. The reason to group them by topmost assigned domain is to\n&gt; support subdo=\r\nmain cookie inheritance.\n&gt;\n&gt; I&#39;ve implemented this and created a pull reque=\r\nst. I think it deserves\n&gt; more testing before mergin. If anyone wants to co=\r\nntribute more unit\n&gt; tests that would be greatly appreciated.\n&gt; https://git=\r\nhub.com/internetarchive/heritrix3/pull/96\n&gt;\n&gt; Noah\n&gt;\n&gt;\n&gt; On Fri, Sep 26, 20=\r\n14 at 5:43 AM, Kristinn Sigur=C3=B0sson\n&gt; kristinn@... [archiv=\r\ne-crawler]\n&gt; &lt;archive-crawler@yahoogroups.com&gt; wrote:\n&gt;&gt; Hi all,\n&gt;&gt;\n&gt;&gt; Just=\r\n wanted to follow up on Roger&#39;s e-mail from earlier this week.\n&gt;&gt;\n&gt;&gt; The bu=\r\ng he mentions (HER-2070, or &#39;Cookie Monster&#39; as I prefer to think of it) wa=\r\ns independently discovered by Roger and me during the domain crawls of our =\r\nrespective institutions. The bug has been traced to an upgrade of the Apach=\r\ne HttpClient library that Heritrix uses.\n&gt;&gt;\n&gt;&gt; The old library had been mod=\r\nified to (among other things) allow Heritrix to only pass it relevant cooki=\r\nes when making HTTP requests. This enabled Heritrix to use a disk backed da=\r\nta structure to store the cookies, keyed off of the domain names.\n&gt;&gt;\n&gt;&gt; At =\r\nsome point between Heritrix 3.1.0 release and now the library was upgraded =\r\n(although not fully, there is still a dependency on the old one pulled in) =\r\nand at the same time all the tweaks were thrown out.\n&gt;&gt;\n&gt;&gt; This meant that =\r\nnow for each request the Apache HttpClient accesses a list of ALL cookies a=\r\nnd iterates over it (sequentially) to find the ones that are appropriate to=\r\n the current request.\n&gt;&gt;\n&gt;&gt; This has two problems.\n&gt;&gt;\n&gt;&gt; 1. Efficiency. It =\r\ntakes a lot of time to iterate over all the cookies, especially as it is do=\r\nne for every request. This also consumes a lot of memory since you can&#39;t re=\r\nally back this out to disk when all the cookies are referenced all the time=\r\n.\n&gt;&gt;\n&gt;&gt; 2. Access to this list isn&#39;t thread safe! Synchronizing access woul=\r\nd impact performance even further so that isn&#39;t really a solution. Since ac=\r\ncess isn&#39;t safe you wind up with the wrong cookie getting sent on occasion.=\r\n You also, occasionally, hit an NPE. Both are caused by one thread changing=\r\n the cookie data structure while another is reading it.\n&gt;&gt;\n&gt;&gt; Due to the na=\r\nture of this bug, it is most evident when doing large scale crawls (about 1=\r\n URL in 5.000 is killed by an NPE). Despite that I&#39;m still surprised more p=\r\neople haven&#39;t come forward to report this bug, given how pernicious it is. =\r\nAre most people using older versions of Heritrix?\n&gt;&gt;\n&gt;&gt; So, I&#39;d like to ech=\r\no Rogers question; have you encountered this (you may want to check your ru=\r\nntime-errors.log)?\n&gt;&gt;\n&gt;&gt; I&#39;d also like to ask if anyone has done anything t=\r\no address/mitigate this bug? As far as I can tell, the only viable option a=\r\nre to either hack the new version of HttpClient or revert to the old, alrea=\r\ndy hacked, version.\n&gt;&gt;\n&gt;&gt; If anyone is working on this bug or has a workaro=\r\nund, I&#39;d love to hear about it.\n&gt;&gt;\n&gt;&gt; Best,\n&gt;&gt; Kris\n&gt;&gt;\n&gt;&gt; -----------------=\r\n--------------------------------------------------------\n&gt;&gt; Landsb=C3=B3kas=\r\nafn =C3=8Dslands - H=C3=A1sk=C3=B3lab=C3=B3kasafn | Arngr=C3=ADmsg=C3=B6tu =\r\n3 - 107 Reykjav=C3=ADk\n&gt;&gt; S=C3=ADmi/Tel: +354 5255600 | www.landsbokasafn.i=\r\ns\n&gt;&gt; ----------------------------------------------------------------------=\r\n---\n&gt;&gt; fyrirvari/disclaimer - http://fyrirvari.landsbokasafn.is\n&gt;&gt;&gt; -----Or=\r\niginal Message-----\n&gt;&gt;&gt; From: archive-crawler@yahoogroups.com [mailto:archi=\r\nve-\n&gt;&gt;&gt; crawler@yahoogroups.com]\n&gt;&gt;&gt; Sent: 22. september 2014 09:05\n&gt;&gt;&gt; To:=\r\n archive-crawler@yahoogroups.com\n&gt;&gt;&gt; Subject: [archive-crawler] HER-2070\n&gt;&gt;=\r\n&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt; Just wondering if anyone else is seeing fallout from the issu=\r\ne identified in\n&gt;&gt;&gt; HER-2070 (https://webarchive.jira.com/browse/HER-2070)?=\r\n\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt; In addition to the cookie-related issues and various Excep=\r\ntions, we=E2=80=99re also\n&gt;&gt;&gt; seeing a significant decrease in speed with m=\r\nost of the threads hanging at\n&gt;&gt;&gt; the FetchHTTPRequest.execute() method.\n&gt;&gt;=\r\n&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt; Roger\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt; *******************************=\r\n***************************\n&gt;&gt;&gt; *******************************************=\r\n*************\n&gt;&gt;&gt; Experience the British Library online at www.bl.uk &lt;http:=\r\n//www.bl.uk/&gt; The\n&gt;&gt;&gt; British Library=E2=80=99s latest Annual Report and Ac=\r\ncounts :\n&gt;&gt;&gt; www.bl.uk/aboutus/annrep/index.html\n&gt;&gt;&gt; &lt;http://www.bl.uk/abou=\r\ntus/annrep/index.html&gt;\n&gt;&gt;&gt; Help the British Library conserve the world&#39;s kn=\r\nowledge. Adopt a Book.\n&gt;&gt;&gt; www.bl.uk/adoptabook &lt;http://www.bl.uk/adoptaboo=\r\nk&gt; The Library&#39;s St\n&gt;&gt;&gt; Pancras site is WiFi - enabled\n&gt;&gt;&gt; ****************=\r\n******************************************\n&gt;&gt;&gt; ****************************=\r\n***************************\n&gt;&gt;&gt; The information contained in this e-mail is=\r\n confidential and may be legally\n&gt;&gt;&gt; privileged. It is intended for the add=\r\nressee(s) only. If you are not the\n&gt;&gt;&gt; intended recipient, please delete th=\r\nis e-mail and notify the\n&gt;&gt;&gt; postmaster@... &lt;mailto:postmaster@...&gt;  : =\r\nThe contents of this e-mail\n&gt;&gt;&gt; must not be disclosed or copied without the=\r\n sender&#39;s consent.\n&gt;&gt;&gt; The statements and opinions expressed in this messag=\r\ne are those of the\n&gt;&gt;&gt; author and do not necessarily reflect those of the B=\r\nritish Library. The British\n&gt;&gt;&gt; Library does not take any responsibility fo=\r\nr the views of the author.\n&gt;&gt;&gt; ********************************************=\r\n**************\n&gt;&gt;&gt; *******************************************************\n=\r\n&gt;&gt;&gt; Think before you print\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;\n&gt;&gt;\n&gt;&gt; -------------------------------=\r\n-----\n&gt;&gt; Posted by: =3D?utf-8?B?S3Jpc3Rpbm4gU2lndXLDsHNzb24=3D?=3D &lt;kristin=\r\nn@...&gt;\n&gt;&gt; ------------------------------------\n&gt;&gt;\n&gt;&gt;\n&gt;&gt; ------=\r\n------------------------------\n&gt;&gt;\n&gt;&gt; Yahoo Groups Links\n&gt;&gt;\n&gt;&gt;\n&gt;&gt;\n\n"}}