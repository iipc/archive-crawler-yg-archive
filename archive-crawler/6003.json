{"ygPerms":{"resourceCapabilityList":[{"resourceType":"GROUP","capabilities":[{"name":"READ"},{"name":"JOIN"}]},{"resourceType":"PHOTO","capabilities":[]},{"resourceType":"FILE","capabilities":[]},{"resourceType":"MEMBER","capabilities":[]},{"resourceType":"LINK","capabilities":[]},{"resourceType":"CALENDAR","capabilities":[]},{"resourceType":"DATABASE","capabilities":[]},{"resourceType":"POLL","capabilities":[]},{"resourceType":"MESSAGE","capabilities":[{"name":"READ"}]},{"resourceType":"PENDING_MESSAGE","capabilities":[]},{"resourceType":"ATTACHMENTS","capabilities":[{"name":"READ"}]},{"resourceType":"PHOTOMATIC_ALBUMS","capabilities":[]},{"resourceType":"MEMBERSHIP_TYPE","capabilities":[]},{"resourceType":"POST","capabilities":[{"name":"READ"}]},{"resourceType":"PIN","capabilities":[]}],"groupUrl":"groups.yahoo.com","intlCode":"us"},"comscore":"pageview_candidate","ygData":{"userId":137285340,"authorName":"Gordon Mohr","from":"Gordon Mohr &lt;gojomo@...&gt;","profile":"gojomo","replyTo":"LIST","senderId":"hkMp1mfQlK-jGyWgAzwIJl5ZvTlr4hRA_CBNXpeu9lvb4-ra6_51IvwN01PERDpUAS-kDKM_VcBFKiNZQGk1j9K7SnmOxCA","spamInfo":{"isSpam":false,"reason":"6"},"subject":"Re: [archive-crawler] Re: H3 - Possible memory leak?","postDate":"1251161312","msgId":6003,"canDelete":false,"contentTrasformed":false,"systemMessage":false,"headers":{"messageIdInHeader":"PDRBOTMzNEUwLjgwMTA5QGFyY2hpdmUub3JnPg==","inReplyToHeader":"PGg2djFkYitpY3ZzQGVHcm91cHMuY29tPg==","referencesHeader":"PGg2djFkYitpY3ZzQGVHcm91cHMuY29tPg=="},"prevInTopic":6002,"nextInTopic":6004,"prevInTime":6002,"nextInTime":6004,"topicId":5998,"numMessagesInTopic":7,"msgSnippet":"... Do you *need* to do a toString()? (Is there any way you can stream the data to its ultimate destination? Perhaps straight from the binary ","rawEmail":"Return-Path: &lt;gojomo@...&gt;\r\nX-Sender: gojomo@...\r\nX-Apparently-To: archive-crawler@yahoogroups.com\r\nX-Received: (qmail 3598 invoked from network); 25 Aug 2009 00:49:33 -0000\r\nX-Received: from unknown (69.147.108.201)\n  by m5.grp.re1.yahoo.com with QMQP; 25 Aug 2009 00:49:33 -0000\r\nX-Received: from unknown (HELO relay02.pair.com) (209.68.5.16)\n  by mta2.grp.re1.yahoo.com with SMTP; 25 Aug 2009 00:49:33 -0000\r\nX-Received: (qmail 73302 invoked from network); 25 Aug 2009 00:48:32 -0000\r\nX-Received: from 67.188.14.54 (HELO ?192.168.1.108?) (67.188.14.54)\n  by relay02.pair.com with SMTP; 25 Aug 2009 00:48:32 -0000\r\nX-pair-Authenticated: 67.188.14.54\r\nMessage-ID: &lt;4A9334E0.80109@...&gt;\r\nDate: Mon, 24 Aug 2009 17:48:32 -0700\r\nUser-Agent: Thunderbird 2.0.0.23 (Windows/20090812)\r\nMIME-Version: 1.0\r\nTo: archive-crawler@yahoogroups.com\r\nReferences: &lt;h6v1db+icvs@...&gt;\r\nIn-Reply-To: &lt;h6v1db+icvs@...&gt;\r\nContent-Type: text/plain; charset=ISO-8859-1; format=flowed\r\nContent-Transfer-Encoding: 7bit\r\nX-eGroups-Msg-Info: 1:6:0:0:0\r\nFrom: Gordon Mohr &lt;gojomo@...&gt;\r\nSubject: Re: [archive-crawler] Re: H3 - Possible memory leak?\r\nX-Yahoo-Group-Post: member; u=137285340; y=vybslvPOAfs6Gq8jg7AZ2wE6fuIAc0-Gi2DogFL21k3c\r\nX-Yahoo-Profile: gojomo\r\n\r\nprogre55 wrote:\n&gt; Well, I mostly crawl swedish sites, and as I have noticed, most of them use utf-8, but some use iso-8859-1, too. However, for me personally, utf-8 is admirable :)\n&gt; \n&gt;&gt; &quot;More than likely, much of the slowness you\n&gt; see happens when the GenericReplayCharSequence is created, since the\n&gt; entire file is decoded and written to disk in UTF-16.&quot;\n&gt; \n&gt; Here is a screenshot I had posted some time ago http://files.getdropbox.com/u/1571029/profiler.jpg\n&gt; as can be seen here, much of the slowness is caused when I convert GenericReplayCharSequence to String (GenericReplayCharSequence.toString()).\n\nDo you *need* to do a toString()? (Is there any way you can stream the \ndata to its ultimate destination? Perhaps straight from the binary \ngetReplayInputStream()?)\n\n&gt; \n&gt;&gt; &quot;Ikrom, thanks for the data -- but I think it&#39;s reflective of a lot of new allocation, rather than a memory/reference leak that fails to be freed. Otherwise, a large crawl would OOME fairly quickly.&quot;\n&gt; \n&gt; I haven&#39;t tried a huge crawl yet, but the more links I crawl, the more memory is consumed and not freed. I even explicitly call the garbage collector, no use. And as the screenshot shows, 82% of the memory is held by java.nio.charset.CharsetDecoder.decode(ByteBuffer) http://dl.getdropbox.com/u/1571029/yourkitprofiler.jpg\n\nThere&#39;s never a guarantee that explicit calls to GC will do anything -- \nthe JVM retains the right to do GC however it likes. A larger symptom \nsomething is wrong would be if total memory usage never goes down after \napproaching the max-heap-size, in the usual sawtooth pattern... or if \nthe sawtooth is very shallow. But in such cases, an OOME usually isn&#39;t \nfar behind.\n\nSo the evidence that 904MB of your heap objects was allocated there is \nnotable, but not necessarily evidence that the same space isn&#39;t \navailable, as soon as it&#39;s needed, for other purposes.\n\n- Gordon @ IA\n\n&gt; I&#39;ll try to run a bigger crawl and scrutinize it deeper soon.\n&gt; \n&gt; cheers,\n&gt; Ikrom (@...) \n&gt; \n&gt; \n&gt; --- In archive-crawler@yahoogroups.com, Noah Levitt &lt;nlevitt@...&gt; wrote:\n&gt;&gt;\n&gt;&gt; Gordon Mohr wrote:\n&gt;&gt;&gt; The thought that UTF-8 was a more appropriate modern default (matching \n&gt;&gt;&gt; browser behavior) was the motivation, but further analysis of the choice \n&gt;&gt;&gt; is a top priority issue before the final H3 release.\n&gt;&gt; Actually I think latin1 is still the default fallback encoding in US browsers. At least, it is in my browser (firefox 3.0). Edit/Preferences/Content/Fonts & Colors -&gt; Advanced...\n&gt;&gt;\n&gt;&gt; Noah\n&gt;&gt;\n&gt;&gt;\n&gt;&gt;&gt; Ikrom, thanks for the data -- but I think it&#39;s reflective of a lot of \n&gt;&gt;&gt; new allocation, rather than a memory/reference leak that fails to be \n&gt;&gt;&gt; freed. Otherwise, a large crawl would OOME fairly quickly.\n&gt;&gt;&gt;\n&gt;&gt;&gt; Still, the performance hit is a concern. For the core crawler, our chief \n&gt;&gt;&gt; goal is to ensure all outlink URIs are found... though some applications \n&gt;&gt;&gt; may be more interested in accurate non-URI content extraction. More \n&gt;&gt;&gt; research into tradeoffs is needed, probably involving some big \n&gt;&gt;&gt; comparative crawls to discover cases where the different defaults yield \n&gt;&gt;&gt; different crawler behavior.\n&gt;&gt;&gt;\n&gt;&gt;&gt; - Gordon @ IA\n&gt;&gt;&gt;\n&gt;&gt;&gt; Noah Levitt wrote:\n&gt;&gt;&gt;&gt; Thanks Ikrom for the report. More than likely, much of the slowness you \n&gt;&gt;&gt;&gt; see happens when the GenericReplayCharSequence is created, since the \n&gt;&gt;&gt;&gt; entire file is decoded and written to disk in UTF-16.\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; Do you have any example urls that trigger the slowness?\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; Gordon, I see the change you made falls back to utf-8 when the web page \n&gt;&gt;&gt;&gt; specifies a bogus encoding. Is that because you found cases where utf-8 \n&gt;&gt;&gt;&gt; was the correct encoding, or did you choose utf-8 just as a standard \n&gt;&gt;&gt;&gt; default? If the latter, it might be better to fall back on on \n&gt;&gt;&gt;&gt; single-byte encoding like latin1. Then GenericReplayCharSequence will \n&gt;&gt;&gt;&gt; not need to create a second UTF-16 temp file.\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; Noah\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; progre55 wrote:\n&gt;&gt;&gt;&gt;&gt; Hi people!\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt; I&#39;ve been using heritrix3 now, and as I have written before, after Gordon has changed default character encding to utf-8 and the ReplayCharSequence().toString() method, there has been some significant drop in the crawl performance. Here is a snapshot from a profiler that shows that there might even be a memory-leak in some of those methods http://dl.getdropbox.com/u/1571029/yourkitprofiler.jpg\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt; Gordon, could you please have a look at that and possibly try to fix it?\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt; Thanks in advance.\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt; cheers,\n&gt;&gt;&gt;&gt;&gt; Ikrom (@...)\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt; ------------------------------------\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt; Yahoo! Groups Links\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt;   \n&gt;&gt;&gt;&gt; ------------------------------------\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; Yahoo! Groups Links\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt; ------------------------------------\n&gt;&gt;&gt;\n&gt;&gt;&gt; Yahoo! Groups Links\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt; \n&gt; \n&gt; \n&gt; \n&gt; ------------------------------------\n&gt; \n&gt; Yahoo! Groups Links\n&gt; \n&gt; \n&gt; \n\n"}}