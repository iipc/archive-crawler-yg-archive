{"ygPerms":{"resourceCapabilityList":[{"resourceType":"GROUP","capabilities":[{"name":"READ"},{"name":"JOIN"}]},{"resourceType":"PHOTO","capabilities":[]},{"resourceType":"FILE","capabilities":[]},{"resourceType":"MEMBER","capabilities":[]},{"resourceType":"LINK","capabilities":[]},{"resourceType":"CALENDAR","capabilities":[]},{"resourceType":"DATABASE","capabilities":[]},{"resourceType":"POLL","capabilities":[]},{"resourceType":"MESSAGE","capabilities":[{"name":"READ"}]},{"resourceType":"PENDING_MESSAGE","capabilities":[]},{"resourceType":"ATTACHMENTS","capabilities":[{"name":"READ"}]},{"resourceType":"PHOTOMATIC_ALBUMS","capabilities":[]},{"resourceType":"MEMBERSHIP_TYPE","capabilities":[]},{"resourceType":"POST","capabilities":[{"name":"READ"}]},{"resourceType":"PIN","capabilities":[]}],"groupUrl":"groups.yahoo.com","intlCode":"us"},"comscore":"pageview_candidate","ygData":{"userId":325624130,"authorName":"Noah Levitt","from":"Noah Levitt &lt;nlevitt@...&gt;","profile":"nlevitt0","replyTo":"LIST","senderId":"fOV_yt3saMmMnkXmjBMbLr5PQIV58YRYUdfX10YvuVcXyINDQp3PTiJ45VbhiAgbMrlByoikspnry9TGBu-E9PySn46-3tXP","spamInfo":{"isSpam":false,"reason":"12"},"subject":"Re: [archive-crawler] Support for encoding","postDate":"1213149969","msgId":5303,"canDelete":false,"contentTrasformed":false,"systemMessage":false,"headers":{"messageIdInHeader":"PDQ4NEYzMzExLjYwNDA4MDJAYXJjaGl2ZS5vcmc+","inReplyToHeader":"PDQ4NDgxRDRDLjkwNTAwMDdAYXJjaGl2ZS5vcmc+","referencesHeader":"PGQ2MWM1NzMwMDgwNjAyMTEyN2wyMDMxOWRiZmsxNGNmNjhhMmI5Y2Q4ZDIyQG1haWwuZ21haWwuY29tPgkgPDQ4NDQ2N0Y1LjkwMjAwQGFyY2hpdmUub3JnPiA8ZDYxYzU3MzAwODA2MDQwNDM1aDNiYThmMTljcWVlNmQ4NmU1MGU2NjY3NWRAbWFpbC5nbWFpbC5jb20+IDw0ODQ3OEIxNS42MDMwMTAxQGFyY2hpdmUub3JnPiA8NDg0Nzk4NDcuODAxMDkwNEBhcmNoaXZlLm9yZz4gPDQ4NDgxRDRDLjkwNTAwMDdAYXJjaGl2ZS5vcmc+"},"prevInTopic":5290,"nextInTopic":5311,"prevInTime":5302,"nextInTime":5304,"topicId":5266,"numMessagesInTopic":9,"msgSnippet":"I attached a patch to the jira issue http://webteam.archive.org/jira/browse/HER-1506. Basically, (char)(c & 0xff) is correct only for latin1, because 0x00-0xff","rawEmail":"Return-Path: &lt;nlevitt@...&gt;\r\nX-Sender: nlevitt@...\r\nX-Apparently-To: archive-crawler@yahoogroups.com\r\nX-Received: (qmail 10457 invoked from network); 11 Jun 2008 02:06:11 -0000\r\nX-Received: from unknown (66.218.67.94)\n  by m50.grp.scd.yahoo.com with QMQP; 11 Jun 2008 02:06:11 -0000\r\nX-Received: from unknown (HELO mail.archive.org) (207.241.231.239)\n  by mta15.grp.scd.yahoo.com with SMTP; 11 Jun 2008 02:06:11 -0000\r\nX-Received: from localhost (localhost [127.0.0.1])\n\tby mail.archive.org (Postfix) with ESMTP id D759519BA9C\n\tfor &lt;archive-crawler@yahoogroups.com&gt;; Tue, 10 Jun 2008 19:00:24 -0700 (PDT)\r\nX-Received: from mail.archive.org ([127.0.0.1])\n\tby localhost (mail.archive.org [127.0.0.1]) (amavisd-new, port 10024)\n\twith LMTP id 6OIEDXKXB7a9 for &lt;archive-crawler@yahoogroups.com&gt;;\n\tTue, 10 Jun 2008 19:00:23 -0700 (PDT)\r\nX-Received: from [192.168.1.204] (c-67-180-197-118.hsd1.ca.comcast.net [67.180.197.118])\n\tby mail.archive.org (Postfix) with ESMTPSA id A7FAD19BA9B\n\tfor &lt;archive-crawler@yahoogroups.com&gt;; Tue, 10 Jun 2008 19:00:23 -0700 (PDT)\r\nMessage-ID: &lt;484F3311.6040802@...&gt;\r\nDate: Tue, 10 Jun 2008 19:06:09 -0700\r\nUser-Agent: Thunderbird 2.0.0.14 (X11/20080502)\r\nMIME-Version: 1.0\r\nTo: archive-crawler@yahoogroups.com\r\nReferences: &lt;d61c57300806021127l20319dbfk14cf68a2b9cd8d22@...&gt;\t &lt;484467F5.90200@...&gt; &lt;d61c57300806040435h3ba8f19cqee6d86e50e66675d@...&gt; &lt;48478B15.6030101@...&gt; &lt;48479847.8010904@...&gt; &lt;48481D4C.9050007@...&gt;\r\nIn-Reply-To: &lt;48481D4C.9050007@...&gt;\r\nContent-Type: text/plain; charset=UTF-8; format=flowed\r\nContent-Transfer-Encoding: 8bit\r\nX-eGroups-Msg-Info: 1:12:0:0:0\r\nFrom: Noah Levitt &lt;nlevitt@...&gt;\r\nSubject: Re: [archive-crawler] Support for encoding\r\nX-Yahoo-Group-Post: member; u=325624130; y=EWb9GW8tcShgfdHmB_YJuqJZdTx4zwzFHrEM2-yAVIM9-WU\r\nX-Yahoo-Profile: nlevitt0\r\n\r\nI attached a patch to the jira issue http://webteam.archive.org/jira/browse/HER-1506. Basically, (char)(c & 0xff) is correct only for latin1, because 0x00-0xff are the same characters as U+0000-U+00ff. So the patch uses ByteReplayCharSequence only for latin1.\n\nNoah\n\nGordon Mohr wrote:\n&gt; Noah Levitt wrote:\n&gt;&gt; (commented on the jira issue) I don&#39;t think the problem here is the mask \n&gt;&gt; (which looks like 8 bits to me). What&#39;s happening with, for example, the \n&gt;&gt; euro character (€) on a windows-1252 encoded page (0x80) is that when \n&gt;&gt; you cast it to char it takes the numeric value as a unicode codepoint. \n&gt;&gt; 0x80 is a control character in unicode. The correct conversion would be \n&gt;&gt; to 0x20ac, which can be obtained with new String(byte[] {0x80}, \n&gt;&gt; &quot;windows-1252&quot;), or maybe more efficiently with a CharsetDecoder.\n&gt; \n&gt; I think there are two problems: not considering the encoding in use, and \n&gt; further masking the return value to 8 bits, when a char would normally \n&gt; include values outside an 8-bit range. Either alone is enough so that \n&gt; ByteReplayCharSequence.charAt() will give a wrong result for certain \n&gt; characters.\n&gt; \n&gt; Yes, the fix is to apply the appropriate charset decoding to the bytes, \n&gt; and completely eliminate the masking on that result.\n&gt; \n&gt; However, we&#39;re unlikely to want to do the decoding a byte at a time in \n&gt; charAt() -- the Java decoders, even for single-byte encodings, don&#39;t \n&gt; offer operations on single bytes, only ByteBuffers into CharBuffers. So \n&gt; some other refactoring to do decoding in larger batches will likely be \n&gt; worthwhile.\n&gt; \n&gt; - Gordon @ IA\n&gt; \n&gt;&gt; Noah\n&gt;&gt;\n&gt;&gt; Gordon Mohr wrote:\n&gt;&gt;&gt; Jean-Noël Rivasseau wrote:\n&gt;&gt;&gt;   \n&gt;&gt;&gt;&gt; Hello.\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; My problem was that I had a page that was actually encoded in\n&gt;&gt;&gt;&gt; windows-1252 cp, but advertised itself as a ISO-8859-1 page (although\n&gt;&gt;&gt;&gt; it did this only in the HTML content of the page, not on the\n&gt;&gt;&gt;&gt; appropriate place - the HTTP headers, but anyway as you pointed\n&gt;&gt;&gt;&gt; Heritrix probably picked ISO-8859-1 as default).\n&gt;&gt;&gt;&gt;     \n&gt;&gt;&gt; Was there any hint or declaration that windows-1252 was the proper \n&gt;&gt;&gt; encoding, or would it have to be deduced by statistical guesswork from \n&gt;&gt;&gt; that page if you didn&#39;t already know the expected encoding? (Is this a \n&gt;&gt;&gt; public URL you can share?)\n&gt;&gt;&gt;\n&gt;&gt;&gt;   \n&gt;&gt;&gt;&gt; In my Processor I manually forced the encoding like this (uri is a\n&gt;&gt;&gt;&gt; ProcessorURI):\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; uri.getRecorder().setCharacterEncoding(&quot;windows-1252&quot;);\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; However, although my JVM perfectly supports this encoding (I checked),\n&gt;&gt;&gt;&gt; things were still not working, specifically, the Euro currency\n&gt;&gt;&gt;&gt; character/symbol, coded by the byte 80 in hex in Windows-1252,\n&gt;&gt;&gt;&gt; appeared garbled when I converted the uri to a String via\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; String content = uri.getRecorder().getReplayCharSequence().toString();\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; I looked at the source and found this strange comment in the\n&gt;&gt;&gt;&gt; getReplayCharSequence() of RecordingOutputStream :\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; // TODO: take into account single-byte encoding may be non-default\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; Closer examination of the code reveals that the comment is right - the\n&gt;&gt;&gt;&gt; encoding is downright ignored for single-byte encodings... this can be\n&gt;&gt;&gt;&gt; seen immediately by the fact that the encoding argument is not passed\n&gt;&gt;&gt;&gt; down to further methods in the chain.\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; So the stream of bytes is not correctly converted to a char (actual\n&gt;&gt;&gt;&gt; conversion appears in the charAt method of ByteReplayCharSequence):\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; return (char)(c & 0xff);\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; where c is an int. I guess this formula is correct only for ISO-8859-1.\n&gt;&gt;&gt;&gt;     \n&gt;&gt;&gt; This is definitely a problem; I&#39;ve created a new bug:\n&gt;&gt;&gt;\n&gt;&gt;&gt;    http://webteam.archive.org/jira/browse/HER-1506\n&gt;&gt;&gt;\n&gt;&gt;&gt; I think it&#39;s gone unnoticed for a while because:\n&gt;&gt;&gt;   - this masking won&#39;t hurt single-byte characters &lt;= 0x7F\n&gt;&gt;&gt;   - prevalent single-byte encodings are very similar in this range \n&gt;&gt;&gt; inherited from ASCII\n&gt;&gt;&gt;   - our usual configurations only use the ReplayCharSequence for link \n&gt;&gt;&gt; extraction, and link delimiters and link characters are often limited to \n&gt;&gt;&gt; ASCII, even when other content on the page varies\n&gt;&gt;&gt;\n&gt;&gt;&gt;   \n&gt;&gt;&gt;&gt; Maybe this could be easily fixed by a patch, but currently this\n&gt;&gt;&gt;&gt; clearly means only ISO-8859-1 is supported as a single byte encoding (\n&gt;&gt;&gt;&gt; I did not look much at multibyte encoding support but hope it is\n&gt;&gt;&gt;&gt; better).\n&gt;&gt;&gt;&gt;     \n&gt;&gt;&gt; Actually, it&#39;s a little worse than that: only bytes &lt;=0x7F are read \n&gt;&gt;&gt; properly from a (Single)ByteReplayCharSequence.\n&gt;&gt;&gt;\n&gt;&gt;&gt;   \n&gt;&gt;&gt;&gt; As getting back the actual bytes is also quite difficult, the priority\n&gt;&gt;&gt;&gt; of this fix should be high IMHO.\n&gt;&gt;&gt;&gt;     \n&gt;&gt;&gt; It&#39;s actually quite easy to get the raw bytes: use the \n&gt;&gt;&gt; RecordingOutputStream.getReplayInputStream method (or \n&gt;&gt;&gt; getContentReplayInputStream to skip the HTTP headers). That will give a \n&gt;&gt;&gt; raw byte stream of the recorded fetched content.\n&gt;&gt;&gt;\n&gt;&gt;&gt; - Gordon @ IA\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;   \n&gt;&gt;&gt;&gt; Jean-Noel\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; On Mon, Jun 2, 2008 at 11:36 PM, Gordon Mohr &lt;gojomo@...&gt; wrote:\n&gt;&gt;&gt;&gt;     \n&gt;&gt;&gt;&gt;&gt; Jean-Noël Rivasseau wrote:\n&gt;&gt;&gt;&gt;&gt;       \n&gt;&gt;&gt;&gt;&gt;&gt; Hello,\n&gt;&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt;&gt; I had a problem with encoding today and took a look at Heritrix code.\n&gt;&gt;&gt;&gt;&gt;&gt; Unfortunately it seems to me (from my understanding of the code) that\n&gt;&gt;&gt;&gt;&gt;&gt; Heritrix supports only ISO-8859-1 pages and UTF-8 pages. I have a page\n&gt;&gt;&gt;&gt;&gt;&gt; encoded in windows-1252, and Heritrix is not able to read it\n&gt;&gt;&gt;&gt;&gt;&gt; correctly.\n&gt;&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt;&gt; Is better encoding support planned in the reasonable near future? This\n&gt;&gt;&gt;&gt;&gt;&gt; seems not a totally trivial thing to do (else I coul have tried) as\n&gt;&gt;&gt;&gt;&gt;&gt; the code is rather low level (ReplayCharSequence is probably the place\n&gt;&gt;&gt;&gt;&gt;&gt; that would need to be fixed) and I am not sure how to proceed.\n&gt;&gt;&gt;&gt;&gt;&gt;         \n&gt;&gt;&gt;&gt;&gt; Heritrix should already support many other encodings -- limited mainly\n&gt;&gt;&gt;&gt;&gt; by what support is in your Java VM.\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt; As per HTTP/1.1, when no other charset is specified, ISO-8859-1 is\n&gt;&gt;&gt;&gt;&gt; assumed. See:\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt; http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.7.1\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt; Can you be more specific about the problem you encountered? What did\n&gt;&gt;&gt;&gt;&gt; Heritrix not read that you tried?\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt; - Gordon @ IA\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;&gt;       \n&gt;&gt;&gt;&gt; ------------------------------------\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt; Yahoo! Groups Links\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;\n&gt;&gt;&gt;&gt;     \n&gt;&gt;&gt; ------------------------------------\n&gt;&gt;&gt;\n&gt;&gt;&gt; Yahoo! Groups Links\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;\n&gt;&gt;&gt;   \n&gt;&gt; ------------------------------------\n&gt;&gt;\n&gt;&gt; Yahoo! Groups Links\n&gt;&gt;\n&gt;&gt;\n&gt;&gt;\n&gt; \n&gt; ------------------------------------\n&gt; \n&gt; Yahoo! Groups Links\n&gt; \n&gt; \n&gt; \n\n\n"}}