{"ygPerms":{"resourceCapabilityList":[{"resourceType":"GROUP","capabilities":[{"name":"READ"},{"name":"JOIN"}]},{"resourceType":"PHOTO","capabilities":[]},{"resourceType":"FILE","capabilities":[]},{"resourceType":"MEMBER","capabilities":[]},{"resourceType":"LINK","capabilities":[]},{"resourceType":"CALENDAR","capabilities":[]},{"resourceType":"DATABASE","capabilities":[]},{"resourceType":"POLL","capabilities":[]},{"resourceType":"MESSAGE","capabilities":[{"name":"READ"}]},{"resourceType":"PENDING_MESSAGE","capabilities":[]},{"resourceType":"ATTACHMENTS","capabilities":[{"name":"READ"}]},{"resourceType":"PHOTOMATIC_ALBUMS","capabilities":[]},{"resourceType":"MEMBERSHIP_TYPE","capabilities":[]},{"resourceType":"POST","capabilities":[{"name":"READ"}]},{"resourceType":"PIN","capabilities":[]}],"groupUrl":"groups.yahoo.com","intlCode":"us"},"comscore":"pageview_candidate","ygData":{"userId":328973242,"authorName":"Holger Lausen","from":"Holger Lausen &lt;holger.lausen@...&gt;","profile":"hlausen","replyTo":"LIST","senderId":"p40a6dJ5Q0o9Xi_cFuztMoA_6n6MoV5cjFGC0nsdQJd6l9G5RXE7qPNbi1B9M8Z8aFQcdDtHDsneLCWIdKpiF-Y_pDeaM8kukz3F4jFmOg","spamInfo":{"isSpam":false,"reason":"12"},"subject":"Re: [archive-crawler] Support for encoding","postDate":"1213709645","msgId":5311,"canDelete":false,"contentTrasformed":false,"systemMessage":false,"headers":{"messageIdInHeader":"PDQ4NTdCRDRELjYwNzA2MDdAc2Vla2RhLmNvbT4=","inReplyToHeader":"PDQ4NEYzMzExLjYwNDA4MDJAYXJjaGl2ZS5vcmc+","referencesHeader":"PGQ2MWM1NzMwMDgwNjAyMTEyN2wyMDMxOWRiZmsxNGNmNjhhMmI5Y2Q4ZDIyQG1haWwuZ21haWwuY29tPgkgPDQ4NDQ2N0Y1LjkwMjAwQGFyY2hpdmUub3JnPiA8ZDYxYzU3MzAwODA2MDQwNDM1aDNiYThmMTljcWVlNmQ4NmU1MGU2NjY3NWRAbWFpbC5nbWFpbC5jb20+IDw0ODQ3OEIxNS42MDMwMTAxQGFyY2hpdmUub3JnPiA8NDg0Nzk4NDcuODAxMDkwNEBhcmNoaXZlLm9yZz4gPDQ4NDgxRDRDLjkwNTAwMDdAYXJjaGl2ZS5vcmc+IDw0ODRGMzMxMS42MDQwODAyQGFyY2hpdmUub3JnPg=="},"prevInTopic":5303,"nextInTopic":0,"prevInTime":5310,"nextInTime":5312,"topicId":5266,"numMessagesInTopic":9,"msgSnippet":"Hi, we dealt with a somewhat related problem. Our application required all arc file contents have a uniformly encoded. We did not realize that the","rawEmail":"Return-Path: &lt;holger.lausen@...&gt;\r\nX-Sender: holger.lausen@...\r\nX-Apparently-To: archive-crawler@yahoogroups.com\r\nX-Received: (qmail 95533 invoked from network); 17 Jun 2008 13:34:02 -0000\r\nX-Received: from unknown (66.218.67.94)\n  by m49.grp.scd.yahoo.com with QMQP; 17 Jun 2008 13:34:02 -0000\r\nX-Received: from unknown (HELO mx.inode.at) (62.99.145.15)\n  by mta15.grp.scd.yahoo.com with SMTP; 17 Jun 2008 13:34:02 -0000\r\nX-Received: from [85.124.22.177] (port=3189 helo=[192.168.178.38])\n\tby smartmx-13.inode.at with esmtpsa (TLS-1.0:DHE_RSA_AES_256_CBC_SHA:32)\n\t(Exim 4.50)\n\tid 1K8bJx-0000fz-5Y\n\tfor archive-crawler@yahoogroups.com; Tue, 17 Jun 2008 15:34:01 +0200\r\nMessage-ID: &lt;4857BD4D.6070607@...&gt;\r\nDate: Tue, 17 Jun 2008 15:34:05 +0200\r\nUser-Agent: Thunderbird 2.0.0.14 (X11/20080505)\r\nMIME-Version: 1.0\r\nTo: archive-crawler@yahoogroups.com\r\nReferences: &lt;d61c57300806021127l20319dbfk14cf68a2b9cd8d22@...&gt;\t &lt;484467F5.90200@...&gt; &lt;d61c57300806040435h3ba8f19cqee6d86e50e66675d@...&gt; &lt;48478B15.6030101@...&gt; &lt;48479847.8010904@...&gt; &lt;48481D4C.9050007@...&gt; &lt;484F3311.6040802@...&gt;\r\nIn-Reply-To: &lt;484F3311.6040802@...&gt;\r\nX-Enigmail-Version: 0.95.0\r\nContent-Type: text/plain; charset=UTF-8\r\nContent-Transfer-Encoding: 8bit\r\nX-eGroups-Msg-Info: 1:12:0:0:0\r\nFrom: Holger Lausen &lt;holger.lausen@...&gt;\r\nSubject: Re: [archive-crawler] Support for encoding\r\nX-Yahoo-Group-Post: member; u=328973242; y=6I9uxU6mlW7hVnpMTvYSeZcin8aqb2JPNAuOq6tbhX3qLg\r\nX-Yahoo-Profile: hlausen\r\n\r\nHi,\n\nwe dealt with a somewhat related problem. Our application required all\narc file contents have a uniformly encoded.\n\nWe did not realize that the ReplayCharSequence could have done so much\nof the work we did within our &quot;UnifromEncodingArcWriter&quot;.\n\nWe would be interested in getting some of the functionality we wrote\n&quot;upstream&quot;, so my question is: is their interest in adding a subclass of\nArcWriter/ReplayCharSequence (or adding the functionality to the current\nclass) that:\n - detects encoding based on header, then content meta info, and then\nusing a char set guesser\n - adds the option to force the encoding of the content (instead of\nwriting only the byte stream) (with defined excetion such as binary content)\n\nbest\n  Holger\n \n\nNoah Levitt wrote:\n&gt;\n&gt; I attached a patch to the jira issue\n&gt; http://webteam.archive.org/jira/browse/HER-1506.\n&gt; &lt;http://webteam.archive.org/jira/browse/HER-1506.&gt; Basically, (char)(c\n&gt; & 0xff) is correct only for latin1, because 0x00-0xff are the same\n&gt; characters as U+0000-U+00ff. So the patch uses ByteReplayCharSequence\n&gt; only for latin1.\n&gt;\n&gt; Noah\n&gt;\n&gt; Gordon Mohr wrote:\n&gt; &gt; Noah Levitt wrote:\n&gt; &gt;&gt; (commented on the jira issue) I don&#39;t think the problem here is the\n&gt; mask\n&gt; &gt;&gt; (which looks like 8 bits to me). What&#39;s happening with, for\n&gt; example, the\n&gt; &gt;&gt; euro character (€) on a windows-1252 encoded page (0x80) is that when\n&gt; &gt;&gt; you cast it to char it takes the numeric value as a unicode codepoint.\n&gt; &gt;&gt; 0x80 is a control character in unicode. The correct conversion\n&gt; would be\n&gt; &gt;&gt; to 0x20ac, which can be obtained with new String(byte[] {0x80},\n&gt; &gt;&gt; &quot;windows-1252&quot;), or maybe more efficiently with a CharsetDecoder.\n&gt; &gt;\n&gt; &gt; I think there are two problems: not considering the encoding in use,\n&gt; and\n&gt; &gt; further masking the return value to 8 bits, when a char would normally\n&gt; &gt; include values outside an 8-bit range. Either alone is enough so that\n&gt; &gt; ByteReplayCharSequence.charAt() will give a wrong result for certain\n&gt; &gt; characters.\n&gt; &gt;\n&gt; &gt; Yes, the fix is to apply the appropriate charset decoding to the bytes,\n&gt; &gt; and completely eliminate the masking on that result.\n&gt; &gt;\n&gt; &gt; However, we&#39;re unlikely to want to do the decoding a byte at a time in\n&gt; &gt; charAt() -- the Java decoders, even for single-byte encodings, don&#39;t\n&gt; &gt; offer operations on single bytes, only ByteBuffers into CharBuffers. So\n&gt; &gt; some other refactoring to do decoding in larger batches will likely be\n&gt; &gt; worthwhile.\n&gt; &gt;\n&gt; &gt; - Gordon @ IA\n&gt; &gt;\n&gt; &gt;&gt; Noah\n&gt; &gt;&gt;\n&gt; &gt;&gt; Gordon Mohr wrote:\n&gt; &gt;&gt;&gt; Jean-Noël Rivasseau wrote:\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; Hello.\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; My problem was that I had a page that was actually encoded in\n&gt; &gt;&gt;&gt;&gt; windows-1252 cp, but advertised itself as a ISO-8859-1 page (although\n&gt; &gt;&gt;&gt;&gt; it did this only in the HTML content of the page, not on the\n&gt; &gt;&gt;&gt;&gt; appropriate place - the HTTP headers, but anyway as you pointed\n&gt; &gt;&gt;&gt;&gt; Heritrix probably picked ISO-8859-1 as default).\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt; Was there any hint or declaration that windows-1252 was the proper\n&gt; &gt;&gt;&gt; encoding, or would it have to be deduced by statistical guesswork\n&gt; from\n&gt; &gt;&gt;&gt; that page if you didn&#39;t already know the expected encoding? (Is\n&gt; this a\n&gt; &gt;&gt;&gt; public URL you can share?)\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; In my Processor I manually forced the encoding like this (uri is a\n&gt; &gt;&gt;&gt;&gt; ProcessorURI):\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; uri.getRecorder().setCharacterEncoding(&quot;windows-1252&quot;);\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; However, although my JVM perfectly supports this encoding (I\n&gt; checked),\n&gt; &gt;&gt;&gt;&gt; things were still not working, specifically, the Euro currency\n&gt; &gt;&gt;&gt;&gt; character/symbol, coded by the byte 80 in hex in Windows-1252,\n&gt; &gt;&gt;&gt;&gt; appeared garbled when I converted the uri to a String via\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; String content =\n&gt; uri.getRecorder().getReplayCharSequence().toString();\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; I looked at the source and found this strange comment in the\n&gt; &gt;&gt;&gt;&gt; getReplayCharSequence() of RecordingOutputStream :\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; // TODO: take into account single-byte encoding may be non-default\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; Closer examination of the code reveals that the comment is right\n&gt; - the\n&gt; &gt;&gt;&gt;&gt; encoding is downright ignored for single-byte encodings... this\n&gt; can be\n&gt; &gt;&gt;&gt;&gt; seen immediately by the fact that the encoding argument is not passed\n&gt; &gt;&gt;&gt;&gt; down to further methods in the chain.\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; So the stream of bytes is not correctly converted to a char (actual\n&gt; &gt;&gt;&gt;&gt; conversion appears in the charAt method of ByteReplayCharSequence):\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; return (char)(c & 0xff);\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; where c is an int. I guess this formula is correct only for\n&gt; ISO-8859-1.\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt; This is definitely a problem; I&#39;ve created a new bug:\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt; http://webteam.archive.org/jira/browse/HER-1506\n&gt; &lt;http://webteam.archive.org/jira/browse/HER-1506&gt;\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt; I think it&#39;s gone unnoticed for a while because:\n&gt; &gt;&gt;&gt; - this masking won&#39;t hurt single-byte characters &lt;= 0x7F\n&gt; &gt;&gt;&gt; - prevalent single-byte encodings are very similar in this range\n&gt; &gt;&gt;&gt; inherited from ASCII\n&gt; &gt;&gt;&gt; - our usual configurations only use the ReplayCharSequence for link\n&gt; &gt;&gt;&gt; extraction, and link delimiters and link characters are often\n&gt; limited to\n&gt; &gt;&gt;&gt; ASCII, even when other content on the page varies\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; Maybe this could be easily fixed by a patch, but currently this\n&gt; &gt;&gt;&gt;&gt; clearly means only ISO-8859-1 is supported as a single byte\n&gt; encoding (\n&gt; &gt;&gt;&gt;&gt; I did not look much at multibyte encoding support but hope it is\n&gt; &gt;&gt;&gt;&gt; better).\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt; Actually, it&#39;s a little worse than that: only bytes &lt;=0x7F are read\n&gt; &gt;&gt;&gt; properly from a (Single)ByteReplayCharSequence.\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; As getting back the actual bytes is also quite difficult, the\n&gt; priority\n&gt; &gt;&gt;&gt;&gt; of this fix should be high IMHO.\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt; It&#39;s actually quite easy to get the raw bytes: use the\n&gt; &gt;&gt;&gt; RecordingOutputStream.getReplayInputStream method (or\n&gt; &gt;&gt;&gt; getContentReplayInputStream to skip the HTTP headers). That will\n&gt; give a\n&gt; &gt;&gt;&gt; raw byte stream of the recorded fetched content.\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt; - Gordon @ IA\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; Jean-Noel\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; On Mon, Jun 2, 2008 at 11:36 PM, Gordon Mohr &lt;gojomo@...\n&gt; &lt;mailto:gojomo%40archive.org&gt;&gt; wrote:\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;&gt; Jean-Noël Rivasseau wrote:\n&gt; &gt;&gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;&gt;&gt; Hello,\n&gt; &gt;&gt;&gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;&gt;&gt; I had a problem with encoding today and took a look at Heritrix\n&gt; code.\n&gt; &gt;&gt;&gt;&gt;&gt;&gt; Unfortunately it seems to me (from my understanding of the\n&gt; code) that\n&gt; &gt;&gt;&gt;&gt;&gt;&gt; Heritrix supports only ISO-8859-1 pages and UTF-8 pages. I have\n&gt; a page\n&gt; &gt;&gt;&gt;&gt;&gt;&gt; encoded in windows-1252, and Heritrix is not able to read it\n&gt; &gt;&gt;&gt;&gt;&gt;&gt; correctly.\n&gt; &gt;&gt;&gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;&gt;&gt; Is better encoding support planned in the reasonable near\n&gt; future? This\n&gt; &gt;&gt;&gt;&gt;&gt;&gt; seems not a totally trivial thing to do (else I coul have tried) as\n&gt; &gt;&gt;&gt;&gt;&gt;&gt; the code is rather low level (ReplayCharSequence is probably\n&gt; the place\n&gt; &gt;&gt;&gt;&gt;&gt;&gt; that would need to be fixed) and I am not sure how to proceed.\n&gt; &gt;&gt;&gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;&gt; Heritrix should already support many other encodings -- limited\n&gt; mainly\n&gt; &gt;&gt;&gt;&gt;&gt; by what support is in your Java VM.\n&gt; &gt;&gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;&gt; As per HTTP/1.1, when no other charset is specified, ISO-8859-1 is\n&gt; &gt;&gt;&gt;&gt;&gt; assumed. See:\n&gt; &gt;&gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;&gt; http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.7.1\n&gt; &lt;http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.7.1&gt;\n&gt; &gt;&gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;&gt; Can you be more specific about the problem you encountered? What did\n&gt; &gt;&gt;&gt;&gt;&gt; Heritrix not read that you tried?\n&gt; &gt;&gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;&gt; - Gordon @ IA\n&gt; &gt;&gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; ------------------------------------\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt; Yahoo! Groups Links\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt;&gt;\n&gt; &gt;&gt;&gt; ------------------------------------\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt; Yahoo! Groups Links\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt;&gt;\n&gt; &gt;&gt; ------------------------------------\n&gt; &gt;&gt;\n&gt; &gt;&gt; Yahoo! Groups Links\n&gt; &gt;&gt;\n&gt; &gt;&gt;\n&gt; &gt;&gt;\n&gt; &gt;\n&gt; &gt; ------------------------------------\n&gt; &gt;\n&gt; &gt; Yahoo! Groups Links\n&gt; &gt;\n&gt; &gt;\n&gt; &gt;\n&gt;\n&gt;  \n\n\n-- \nHolger Lausen\nseekda OG\nMuseumstr. 21/302, 6020 Innsbruck, Austria\nTel: +43 1 2365084, Fax: +43 1 2365084-99\nRegistration Number: FN296905\nRegistration Court: Innsbruck\nWeb: http://seekda.com\nJabber/Mail: holger.lausen@... \n\n\n"}}