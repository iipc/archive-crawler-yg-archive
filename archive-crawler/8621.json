{"ygPerms":{"resourceCapabilityList":[{"resourceType":"GROUP","capabilities":[{"name":"READ"},{"name":"JOIN"}]},{"resourceType":"PHOTO","capabilities":[]},{"resourceType":"FILE","capabilities":[]},{"resourceType":"MEMBER","capabilities":[]},{"resourceType":"LINK","capabilities":[]},{"resourceType":"CALENDAR","capabilities":[]},{"resourceType":"DATABASE","capabilities":[]},{"resourceType":"POLL","capabilities":[]},{"resourceType":"MESSAGE","capabilities":[{"name":"READ"}]},{"resourceType":"PENDING_MESSAGE","capabilities":[]},{"resourceType":"ATTACHMENTS","capabilities":[{"name":"READ"}]},{"resourceType":"PHOTOMATIC_ALBUMS","capabilities":[]},{"resourceType":"MEMBERSHIP_TYPE","capabilities":[]},{"resourceType":"POST","capabilities":[{"name":"READ"}]},{"resourceType":"PIN","capabilities":[]}],"groupUrl":"groups.yahoo.com","intlCode":"us"},"comscore":"pageview_candidate","ygData":{"userId":325624130,"authorName":"Noah Levitt","from":"Noah Levitt &lt;nlevitt@...&gt;","profile":"nlevitt","replyTo":"LIST","senderId":"rHUIMD1a_rxVlfKqvTs9cxmDDU0Uhte752-QorHwkpQ3Zf_qUjbhXSxxi4WeivOzbww4ejcAyfjLJDbNHzj5UPgAbPLIjBzf","spamInfo":{"isSpam":false,"reason":"0"},"subject":"Re: [archive-crawler] RE: HER-2070 or: Any news on the Cookie Monster bug","postDate":"1411852624","msgId":8621,"canDelete":false,"contentTrasformed":false,"systemMessage":false,"headers":{"messageIdInHeader":"PENBQS16NzBKY1c9Nm0tV3c2YTh3Sz1ENm5IUXNHNFhBckRvUG9lWUMyTFBxYytDOU44QUBtYWlsLmdtYWlsLmNvbT4=","inReplyToHeader":"PEU0ODZEOTNFMzcyRDhDNDI4MkU4REYwNzgzOTJGMTJERTBFQzNEQGJsaWtpLmJva2hsYWRhLmxvY2FsPg==","referencesHeader":"PEU0ODZEOTNFMzcyRDhDNDI4MkU4REYwNzgzOTJGMTJERTBFQzNEQGJsaWtpLmJva2hsYWRhLmxvY2FsPg=="},"prevInTopic":8620,"nextInTopic":8623,"prevInTime":8620,"nextInTime":8622,"topicId":8620,"numMessagesInTopic":9,"msgSnippet":"Hello, I think I have a workable solution to this problem. The idea is to organize the cookies in the cookie store by topmost assigned domain, aka top private","rawEmail":"Return-Path: &lt;nlevitt@...&gt;\r\nX-Sender: nlevitt@...\r\nX-Apparently-To: archive-crawler@yahoogroups.com\r\nX-Received: (qmail 13776 invoked by uid 102); 27 Sep 2014 21:17:08 -0000\r\nX-Received: from unknown (HELO mtaq2.grp.bf1.yahoo.com) (10.193.84.33)\n  by m14.grp.bf1.yahoo.com with SMTP; 27 Sep 2014 21:17:08 -0000\r\nX-Received: (qmail 5204 invoked from network); 27 Sep 2014 21:17:08 -0000\r\nX-Received: from unknown (HELO mail.archive.org) (98.138.215.81)\n  by mtaq2.grp.bf1.yahoo.com with SMTP; 27 Sep 2014 21:17:08 -0000\r\nX-Received: from localhost (localhost [127.0.0.1])\n\tby mail.archive.org (Postfix) with ESMTP id ADBCCA621AA\n\tfor &lt;archive-crawler@yahoogroups.com&gt;; Sat, 27 Sep 2014 14:17:07 -0700 (PDT)\r\nX-Received: from mail.archive.org ([127.0.0.1])\n\tby localhost (mail.archive.org [127.0.0.1]) (amavisd-new, port 10024)\n\twith LMTP id 552B+h6i6OnN for &lt;archive-crawler@yahoogroups.com&gt;;\n\tSat, 27 Sep 2014 14:17:05 -0700 (PDT)\r\nX-Received: from mail-qg0-f52.google.com (mail-qg0-f52.google.com [209.85.192.52])\n\tby mail.archive.org (Postfix) with ESMTPSA id A8CEDA620AC\n\tfor &lt;archive-crawler@yahoogroups.com&gt;; Sat, 27 Sep 2014 14:17:05 -0700 (PDT)\r\nX-Received: by mail-qg0-f52.google.com with SMTP id z60so761953qgd.25\n        for &lt;archive-crawler@yahoogroups.com&gt;; Sat, 27 Sep 2014 14:17:04 -0700 (PDT)\r\nMIME-Version: 1.0\r\nX-Received: by 10.229.136.133 with SMTP id r5mr3904650qct.31.1411852624695;\n Sat, 27 Sep 2014 14:17:04 -0700 (PDT)\r\nX-Received: by 10.97.2.169 with HTTP; Sat, 27 Sep 2014 14:17:04 -0700 (PDT)\r\nIn-Reply-To: &lt;E486D93E372D8C4282E8DF078392F12DE0EC3D@...&gt;\r\nReferences: &lt;E486D93E372D8C4282E8DF078392F12DE0EC3D@...&gt;\r\nDate: Sat, 27 Sep 2014 14:17:04 -0700\r\nMessage-ID: &lt;CAA-z70JcW=6m-Ww6a8wK=D6nHQsG4XArDoPoeYC2LPqc+C9N8A@...&gt;\r\nTo: &quot;archive-crawler@yahoogroups.com&quot; &lt;archive-crawler@yahoogroups.com&gt;\r\nContent-Type: text/plain; charset=UTF-8\r\nContent-Transfer-Encoding: quoted-printable\r\nSubject: Re: [archive-crawler] RE: HER-2070 or: Any news on the Cookie Monster bug\r\nX-Yahoo-Group-Post: member; u=325624130; y=vaUbjjono1ZHpxb4nck36mCeuOYx8HfiFF-SJWWwmhLs8w\r\nX-Yahoo-Profile: nlevitt\r\nFrom: Noah Levitt &lt;nlevitt@...&gt;\r\n\r\nHello,\n\nI think I have a workable solution to this problem. The idea is to\n=\r\norganize the cookies in the cookie store by topmost assigned domain,\naka to=\r\np private domain. On each http request, supply to the fetcher an\nimplementa=\r\ntion of org.apache.http.client.CookieStore that is a facade\nover the real c=\r\nookie store, but only knows about the cookies belonging\nto the topmost assi=\r\ngned domain of the url being fetched. That way the\nlist of cookies that get=\r\ns copied and iterated over stays relatively\nsmall. The reason to group them=\r\n by topmost assigned domain is to\nsupport subdomain cookie inheritance.\n\nI&#39;=\r\nve implemented this and created a pull request. I think it deserves\nmore te=\r\nsting before mergin. If anyone wants to contribute more unit\ntests that wou=\r\nld be greatly appreciated.\nhttps://github.com/internetarchive/heritrix3/pul=\r\nl/96\n\nNoah\n\n\nOn Fri, Sep 26, 2014 at 5:43 AM, Kristinn Sigur=C3=B0sson\nkris=\r\ntinn@... [archive-crawler]\n&lt;archive-crawler@yahoogroups.com&gt; w=\r\nrote:\n&gt; Hi all,\n&gt;\n&gt; Just wanted to follow up on Roger&#39;s e-mail from earlier=\r\n this week.\n&gt;\n&gt; The bug he mentions (HER-2070, or &#39;Cookie Monster&#39; as I pre=\r\nfer to think of it) was independently discovered by Roger and me during the=\r\n domain crawls of our respective institutions. The bug has been traced to a=\r\nn upgrade of the Apache HttpClient library that Heritrix uses.\n&gt;\n&gt; The old =\r\nlibrary had been modified to (among other things) allow Heritrix to only pa=\r\nss it relevant cookies when making HTTP requests. This enabled Heritrix to =\r\nuse a disk backed data structure to store the cookies, keyed off of the dom=\r\nain names.\n&gt;\n&gt; At some point between Heritrix 3.1.0 release and now the lib=\r\nrary was upgraded (although not fully, there is still a dependency on the o=\r\nld one pulled in) and at the same time all the tweaks were thrown out.\n&gt;\n&gt; =\r\nThis meant that now for each request the Apache HttpClient accesses a list =\r\nof ALL cookies and iterates over it (sequentially) to find the ones that ar=\r\ne appropriate to the current request.\n&gt;\n&gt; This has two problems.\n&gt;\n&gt; 1. Eff=\r\niciency. It takes a lot of time to iterate over all the cookies, especially=\r\n as it is done for every request. This also consumes a lot of memory since =\r\nyou can&#39;t really back this out to disk when all the cookies are referenced =\r\nall the time.\n&gt;\n&gt; 2. Access to this list isn&#39;t thread safe! Synchronizing a=\r\nccess would impact performance even further so that isn&#39;t really a solution=\r\n. Since access isn&#39;t safe you wind up with the wrong cookie getting sent on=\r\n occasion. You also, occasionally, hit an NPE. Both are caused by one threa=\r\nd changing the cookie data structure while another is reading it.\n&gt;\n&gt; Due t=\r\no the nature of this bug, it is most evident when doing large scale crawls =\r\n(about 1 URL in 5.000 is killed by an NPE). Despite that I&#39;m still surprise=\r\nd more people haven&#39;t come forward to report this bug, given how pernicious=\r\n it is. Are most people using older versions of Heritrix?\n&gt;\n&gt; So, I&#39;d like =\r\nto echo Rogers question; have you encountered this (you may want to check y=\r\nour runtime-errors.log)?\n&gt;\n&gt; I&#39;d also like to ask if anyone has done anythi=\r\nng to address/mitigate this bug? As far as I can tell, the only viable opti=\r\non are to either hack the new version of HttpClient or revert to the old, a=\r\nlready hacked, version.\n&gt;\n&gt; If anyone is working on this bug or has a worka=\r\nround, I&#39;d love to hear about it.\n&gt;\n&gt; Best,\n&gt; Kris\n&gt;\n&gt; --------------------=\r\n-----------------------------------------------------\n&gt; Landsb=C3=B3kasafn =\r\n=C3=8Dslands - H=C3=A1sk=C3=B3lab=C3=B3kasafn | Arngr=C3=ADmsg=C3=B6tu 3 - =\r\n107 Reykjav=C3=ADk\n&gt; S=C3=ADmi/Tel: +354 5255600 | www.landsbokasafn.is\n&gt; -=\r\n------------------------------------------------------------------------\n&gt; =\r\nfyrirvari/disclaimer - http://fyrirvari.landsbokasafn.is\n&gt;&gt; -----Original M=\r\nessage-----\n&gt;&gt; From: archive-crawler@yahoogroups.com [mailto:archive-\n&gt;&gt; cr=\r\nawler@yahoogroups.com]\n&gt;&gt; Sent: 22. september 2014 09:05\n&gt;&gt; To: archive-cra=\r\nwler@yahoogroups.com\n&gt;&gt; Subject: [archive-crawler] HER-2070\n&gt;&gt;\n&gt;&gt;\n&gt;&gt;\n&gt;&gt; Jus=\r\nt wondering if anyone else is seeing fallout from the issue identified in\n&gt;=\r\n&gt; HER-2070 (https://webarchive.jira.com/browse/HER-2070)?\n&gt;&gt;\n&gt;&gt;\n&gt;&gt;\n&gt;&gt; In ad=\r\ndition to the cookie-related issues and various Exceptions, we=E2=80=99re a=\r\nlso\n&gt;&gt; seeing a significant decrease in speed with most of the threads hang=\r\ning at\n&gt;&gt; the FetchHTTPRequest.execute() method.\n&gt;&gt;\n&gt;&gt;\n&gt;&gt;\n&gt;&gt; Roger\n&gt;&gt;\n&gt;&gt;\n&gt;&gt;=\r\n\n&gt;&gt;\n&gt;&gt;\n&gt;&gt; **********************************************************\n&gt;&gt; ***=\r\n*****************************************************\n&gt;&gt; Experience the Bri=\r\ntish Library online at www.bl.uk &lt;http://www.bl.uk/&gt; The\n&gt;&gt; British Library=\r\n=E2=80=99s latest Annual Report and Accounts :\n&gt;&gt; www.bl.uk/aboutus/annrep/=\r\nindex.html\n&gt;&gt; &lt;http://www.bl.uk/aboutus/annrep/index.html&gt;\n&gt;&gt; Help the Brit=\r\nish Library conserve the world&#39;s knowledge. Adopt a Book.\n&gt;&gt; www.bl.uk/adop=\r\ntabook &lt;http://www.bl.uk/adoptabook&gt; The Library&#39;s St\n&gt;&gt; Pancras site is Wi=\r\nFi - enabled\n&gt;&gt; **********************************************************\n=\r\n&gt;&gt; *******************************************************\n&gt;&gt; The informati=\r\non contained in this e-mail is confidential and may be legally\n&gt;&gt; privilege=\r\nd. It is intended for the addressee(s) only. If you are not the\n&gt;&gt; intended=\r\n recipient, please delete this e-mail and notify the\n&gt;&gt; postmaster@... &lt;m=\r\nailto:postmaster@...&gt;  : The contents of this e-mail\n&gt;&gt; must not be discl=\r\nosed or copied without the sender&#39;s consent.\n&gt;&gt; The statements and opinions=\r\n expressed in this message are those of the\n&gt;&gt; author and do not necessaril=\r\ny reflect those of the British Library. The British\n&gt;&gt; Library does not tak=\r\ne any responsibility for the views of the author.\n&gt;&gt; **********************=\r\n************************************\n&gt;&gt; ***********************************=\r\n********************\n&gt;&gt; Think before you print\n&gt;&gt;\n&gt;&gt;\n&gt;\n&gt;\n&gt; ----------------=\r\n--------------------\n&gt; Posted by: =3D?utf-8?B?S3Jpc3Rpbm4gU2lndXLDsHNzb24=\r\n=3D?=3D &lt;kristinn@...&gt;\n&gt; ------------------------------------\n=\r\n&gt;\n&gt;\n&gt; ------------------------------------\n&gt;\n&gt; Yahoo Groups Links\n&gt;\n&gt;\n&gt;\n\n"}}